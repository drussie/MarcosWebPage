<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mortgage Calculator</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b0f19"/>
  <link rel="stylesheet" href="/assets/site.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Mortgage Calculator</h1>
      <div class="actions">
        <button class="btn" id="copyLinkBtn">Copy Link</button>
        <a class="btn" href="/car_loan_calculator.html">Car Loan â†’</a>
      </div>
    </div>

    <div class="grid grid-2">
      <form class="card" id="mortForm">
        <div class="card-title">Inputs</div>

        <div class="row">
          <div>
            <label for="homePrice">Home Price ($)</label>
            <input class="input" type="number" id="homePrice" name="homePrice" value="600000" min="0" step="1000">
          </div>
          <div>
            <label for="downPayment">Down Payment ($)</label>
            <input class="input" type="number" id="downPayment" name="downPayment" value="120000" min="0" step="1000">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="apr">APR (%)</label>
            <input class="input" type="number" id="apr" name="apr" value="6.25" min="0" max="50" step="0.01">
          </div>
          <div>
            <label for="termYears">Term (years)</label>
            <input class="input" type="number" id="termYears" name="termYears" value="30" min="1" max="40">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="taxRate">Property Tax (%/yr)</label>
            <input class="input" type="number" id="taxRate" name="taxRate" value="1.2" min="0" max="10" step="0.01">
          </div>
          <div>
            <label for="insur">Home Insurance ($/yr)</label>
            <input class="input" type="number" id="insur" name="insur" value="1500" min="0" step="50">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="hoa">HOA ($/mo)</label>
            <input class="input" type="number" id="hoa" name="hoa" value="0" min="0" step="10">
          </div>
          <div>
            <label for="loanType">Loan Type</label>
            <select class="input" id="loanType" name="loanType">
              <option value="conventional" selected>Conventional</option>
              <option value="fha">FHA</option>
              <option value="va">VA</option>
            </select>
          </div>
        </div>

        <div class="row">
          <button type="button" class="btn primary" id="calcBtn">Calculate</button>
          <button type="button" class="btn" id="resetBtn">Reset</button>
        </div>
      </form>

      <div class="card" aria-live="polite">
        <div class="card-title">Summary</div>
        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr;">
          <div class="kpi"><div class="label">Monthly (All-in)</div><div class="value" id="kpiMonthly">$0</div></div>
          <div class="kpi"><div class="label">Payment (P&I)</div><div class="value" id="kpiPI">$0</div></div>
          <div class="kpi"><div class="label">PMI</div><div class="value" id="kpiPMI">$0</div></div>
        </div>
        <div class="small" style="margin-top:10px">Shareable link reflects your current inputs.</div>
        <div class="card" style="margin-top:16px">
          <canvas id="chart" height="120"></canvas>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:20px">
      <div class="card-title">Amortization Snapshot</div>
      <div class="table-wrap">
        <table id="table">
          <thead>
            <tr><th>Month</th><th>P&I</th><th>Tax+Ins+HOA+PMI</th><th>Total</th><th>Balance</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <script type="module">
    import { $, $$, clamp, fmtCurrency, parseQuery, bindFormToQuery, readForm } from '/assets/site.js';

    const pmt = (r, n, pv) => r === 0 ? -(pv/n) : -(pv*r*Math.pow(1+r,n))/(Math.pow(1+r,n)-1);
    const monthlyTax = (price, ratePct) => (price * (ratePct/100)) / 12;

    function pmiRequired(loanType, ltvPct) {
      if (loanType === 'va') return false;
      if (loanType === 'fha') return ltvPct > 90; // simplify
      return ltvPct > 80;
    }

    let chart;

    function compute(state) {
      const price = +state.homePrice || 0;
      const down  = clamp(+state.downPayment || 0, 0, price);
      const apr   = clamp(+state.apr || 0, 0, 50) / 100 / 12;
      const years = clamp(+state.termYears || 0, 1, 40);
      const n     = years * 12;

      const taxPct = clamp(+state.taxRate || 0, 0, 10);
      const insYr  = clamp(+state.insur || 0, 0, 1e6);
      const hoa    = clamp(+state.hoa || 0, 0, 1e6);
      const type   = state.loanType || 'conventional';

      const loan  = Math.max(price - down, 0);
      const pi    = Math.abs(pmt(apr, n, loan));
      const taxMo = monthlyTax(price, taxPct);
      const insMo = insYr / 12;

      // Simple PMI model: apply if required until LTV <= 80%
      let bal = loan;
      const rows = [];
      const pmiRateMo = 0.005 * loan / 12; // rough placeholder calculation
      for (let m=1;m<=n;m++) {
        const interest = apr * bal;
        const princ    = Math.min(pi - interest, bal);
        bal = Math.max(bal - princ, 0);
        const ltv = (bal/price) * 100;
        const pmi = pmiRequired(type, ltv) ? pmiRateMo : 0;
        const escrow = taxMo + insMo + hoa + pmi;
        const total  = pi + escrow;
        rows.push([m, pi, escrow, total, bal, pmi]);
      }

      const last = rows[rows.length-1];
      const monthlyAllIn = rows[0][2] + rows[0][1];

      $('#kpiMonthly').textContent = fmtCurrency(monthlyAllIn);
      $('#kpiPI').textContent = fmtCurrency(rows[0][1]);
      $('#kpiPMI').textContent = fmtCurrency(rows[0][5]);

      const tbody = $('#table tbody');
      tbody.innerHTML = rows.slice(0, 360).map(r =>
        `<tr>
          <td>${r[0]}</td>
          <td>${fmtCurrency(r[1])}</td>
          <td>${fmtCurrency(r[2])}</td>
          <td>${fmtCurrency(r[3])}</td>
          <td>${fmtCurrency(r[4])}</td>
        </tr>`).join('');

      const labels = rows.map(r=>r[0]);
      const escrowData = rows.map(r=>r[2]);
      const balance    = rows.map(r=>r[4]);

      if (chart) chart.destroy();
      chart = new Chart($('#chart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { type:'bar', label:'Escrow (tax/ins/HOA/PMI)', data:escrowData },
            { type:'line', label:'Balance', data:balance }
          ]
        },
        options: { responsive:true, scales:{ y:{ beginAtZero:true } } }
      });
    }

    const form = $('#mortForm');
    bindFormToQuery(form, (state)=>compute(state), { debounceMs: 120 });
    compute(readForm(form));

    $('#calcBtn').addEventListener('click', ()=>compute(readForm(form)));
    $('#resetBtn').addEventListener('click', ()=>{
      form.reset();
      history.replaceState(null,'','');
      compute(readForm(form));
    });

    $('#copyLinkBtn').addEventListener('click', async ()=>{
      await navigator.clipboard.writeText(location.href);
      const btn = $('#copyLinkBtn'); const t = btn.textContent;
      btn.textContent = 'Copied!'; setTimeout(()=>btn.textContent=t, 1200);
    });
  </script>
</body>
</html>
