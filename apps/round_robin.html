<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tennis Round Robin</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b0f19"/>
  <link rel="stylesheet" href="/assets/site.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Tennis Round Robin</h1>
      <div class="actions">
        <button class="btn" id="undoBtn" title="Undo last change">Undo</button>
        <button class="btn" id="saveBtn">Save</button>
        <button class="btn" id="loadBtn">Load</button>
        <button class="btn danger" id="clearBtn">Clear</button>
      </div>
    </div>

    <div class="grid grid-2">
      <div class="card">
        <div class="card-title">Setup</div>
        <div class="row">
          <div>
            <label for="eventName">Event Name</label>
            <input class="input" id="eventName" value="Club RR">
          </div>
          <div>
            <label for="players">Players (comma-separated)</label>
            <input class="input" id="players" value="Alice,Bob,Carla,Diego,Erin,Frank">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="format">Format</label>
            <select id="format" class="input">
              <option value="games" selected>Games (to X)</option>
              <option value="points">Points (to X)</option>
              <option value="sets">Best of N sets</option>
            </select>
          </div>
          <div>
            <label for="target">Target (X)</label>
            <input class="input" id="target" type="number" value="6" min="1" max="21">
          </div>
        </div>

        <div class="row">
          <button class="btn primary" id="genBtn">Generate Schedule</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Standings</div>
        <div id="standings" class="small">No matches yet.</div>
      </div>
    </div>

    <div class="card" style="margin-top:20px">
      <div class="card-title">Matches</div>
      <div id="matches">Generate a schedule to begin.</div>
    </div>
  </div>

  <script type="module">
    import { $, $$ } from '/assets/site.js';

    // Persistent state + undo stack
    const KEY = 'rr:v1';
    const state = {
      meta: { name: 'Club RR', format: 'games', target: 6 },
      players: [],
      rounds: [] // [{matches:[{a,b,scoreA,scoreB,done}]}]
    };
    const undoStack = [];

    function pushUndo() {
      undoStack.push(JSON.stringify(state));
      if (undoStack.length > 50) undoStack.shift();
      $('#undoBtn').disabled = undoStack.length === 0;
    }
    function undo() {
      if (!undoStack.length) return;
      const prev = undoStack.pop();
      const obj = JSON.parse(prev);
      Object.assign(state, obj);
      render();
      $('#undoBtn').disabled = undoStack.length === 0;
    }

    function save() {
      localStorage.setItem(KEY, JSON.stringify(state));
    }
    function load() {
      const s = localStorage.getItem(KEY);
      if (s) { Object.assign(state, JSON.parse(s)); render(); }
    }
    function clearAll() {
      pushUndo();
      state.meta = { name:'', format:'games', target:6 };
      state.players = [];
      state.rounds = [];
      render();
      save();
    }

    function parsePlayers(str) {
      return str.split(',').map(s=>s.trim()).filter(Boolean);
    }

    function generateSchedule(players) {
      const ps = players.slice();
      if (ps.length % 2 === 1) ps.push('BYE');
      const n = ps.length;
      const rounds = [];
      const arr = ps.slice(1);
      for (let r=0;r<n-1;r++) {
        const round = { matches: [] };
        const left = [ps[0], ...arr.slice(0, (n/2)-1)];
        const right = arr.slice((n/2)-1).reverse();
        for (let i=0;i<left.length;i++) {
          const a = left[i], b = right[i];
          round.matches.push({ a, b, scoreA:0, scoreB:0, done:false });
        }
        rounds.push(round);
        // rotate
        arr.unshift(arr.pop());
      }
      return rounds;
    }

    function standings() {
      const table = new Map(); // name -> {wins,losses,played,for,against}
      state.players.forEach(p=>table.set(p,{wins:0,losses:0,played:0,for:0,against:0}));
      state.rounds.forEach(r=>r.matches.forEach(m=>{
        if (!m.done) return;
        if (m.a === 'BYE' || m.b === 'BYE') return;
        const ta = table.get(m.a), tb = table.get(m.b);
        ta.played++; tb.played++;
        ta.for += m.scoreA; ta.against += m.scoreB;
        tb.for += m.scoreB; tb.against += m.scoreA;
        if (m.scoreA > m.scoreB) { ta.wins++; tb.losses++; }
        else if (m.scoreB > m.scoreA) { tb.wins++; ta.losses++; }
      }));
      return Array.from(table.entries()).map(([name,st])=>({name,...st})).sort((x,y)=>{
        if (y.wins !== x.wins) return y.wins - x.wins;
        const diffX = x.for - x.against, diffY = y.for - y.against;
        if (diffY !== diffX) return diffY - diffX;
        return y.for - x.for;
      });
    }

    function render() {
      // Header inputs reflect state
      $('#eventName').value = state.meta.name || 'Club RR';
      $('#format').value = state.meta.format || 'games';
      $('#target').value = state.meta.target || 6;
      $('#players').value = state.players.join(',');

      // Matches
      const wrap = $('#matches');
      if (!state.rounds.length) { wrap.textContent = 'Generate a schedule to begin.'; }
      else {
        wrap.innerHTML = state.rounds.map((round, idx)=>{
          const ms = round.matches.map((m, j)=>{
            const disabled = (m.a==='BYE' || m.b==='BYE') ? 'disabled' : '';
            return `<div class="card" style="margin:8px 0;">
              <div class="row" style="align-items:end;">
                <div><label>Match</label><div><strong>R${idx+1}</strong> â€” ${m.a} vs ${m.b}</div></div>
                <div>
                  <label>${m.a} score</label>
                  <input class="input" type="number" min="0" value="${m.scoreA}" data-r="${idx}" data-m="${j}" data-side="A" ${disabled}>
                </div>
                <div>
                  <label>${m.b} score</label>
                  <input class="input" type="number" min="0" value="${m.scoreB}" data-r="${idx}" data-m="${j}" data-side="B" ${disabled}>
                </div>
                <button class="btn" data-r="${idx}" data-m="${j}" data-action="commit" ${disabled}>Commit</button>
                <button class="btn" data-r="${idx}" data-m="${j}" data-action="reset" ${disabled}>Reset</button>
              </div>
            </div>`;
          }).join('');
          return `<div class="card">
            <div class="card-title">Round ${idx+1}</div>
            ${ms}
          </div>`;
        }).join('');
      }

      // Standings
      const st = standings();
      const sEl = $('#standings');
      if (!st.length) sEl.textContent = 'No matches yet.';
      else {
        sEl.innerHTML = `<div class="table-wrap"><table>
          <thead><tr><th>Player</th><th>W</th><th>L</th><th>Diff</th><th>For</th><th>Against</th></tr></thead>
          <tbody>${st.map(x=>`<tr><td>${x.name}</td><td>${x.wins}</td><td>${x.losses}</td><td>${x.for - x.against}</td><td>${x.for}</td><td>${x.against}</td></tr>`).join('')}</tbody>
        </table></div>`;
      }

      // Wire match inputs
      $$('#matches input[type="number"]').forEach(inp=>{
        inp.addEventListener('input', (e)=>{
          const r = +inp.dataset.r, m = +inp.dataset.m, side = inp.dataset.side;
          const val = Math.max(0, +inp.value || 0);
          const match = state.rounds[r].matches[m];
          if (side === 'A') match.scoreA = val; else match.scoreB = val;
        });
      });
      $$('#matches button').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const r = +btn.dataset.r, m = +btn.dataset.m, action = btn.dataset.action;
          const match = state.rounds[r].matches[m];
          if (action === 'commit') {
            if (match.a==='BYE' || match.b==='BYE') return;
            pushUndo();
            match.done = true;
          } else if (action === 'reset') {
            pushUndo();
            match.scoreA = 0; match.scoreB = 0; match.done = false;
          }
          save(); render();
        });
      });
    }

    // UI actions
    $('#genBtn').addEventListener('click', ()=>{
      pushUndo();
      state.meta.name = $('#eventName').value.trim() || 'Club RR';
      state.meta.format = $('#format').value;
      state.meta.target = Math.max(1, +$('#target').value || 6);
      state.players = parsePlayers($('#players').value);

      state.rounds = generateSchedule(state.players);
      save(); render();
    });

    $('#undoBtn').addEventListener('click', undo);
    $('#saveBtn').addEventListener('click', ()=>{ save(); const t=$('#saveBtn').textContent; $('#saveBtn').textContent='Saved'; setTimeout(()=>$('#saveBtn').textContent=t,900); });
    $('#loadBtn').addEventListener('click', ()=>{ load(); const t=$('#loadBtn').textContent; $('#loadBtn').textContent='Loaded'; setTimeout(()=>$('#loadBtn').textContent=t,900); });
    $('#clearBtn').addEventListener('click', ()=>{ if (confirm('Clear tournament and standings?')) { clearAll(); } });

    // Initial
    load();
    if (!state.players.length) render();
    $('#undoBtn').disabled = true;
  </script>
</body>
</html>
